<!--pages/covers/index.wxml-->
<view class="container">
  <!-- 自定义导航栏 - 左边箭头、中间竖线、右边房子 -->
  <view class="custom-navbar">
    <!-- 左边返回按钮 -->
    <view class="nav-button left-button" bindtap="goBack">
      <image class="nav-icon" src="/images/back-icon.png"></image>
    </view>
    
    <!-- 中间分隔竖线 -->
    <view class="nav-separator"></view>
    
    <!-- 右边首页按钮 -->
    <view class="nav-button right-button" bindtap="goHome">
      <image class="nav-icon" src="/images/home-icon.png"></image>
    </view>
  </view>

  <!-- 顶部搜索框 - 紧贴原生导航栏 -->
  <view class="search-header" wx:if="{{!showPreview}}">
    <view class="search-container">
      <input 
        class="search-input" 
        placeholder="输入书名或作者" 
        placeholder-class="search-placeholder"
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindfocus="onSearchFocus"
        bindblur="onSearchBlur"
        bindconfirm="onSearch"
      />
      <text class="clear-icon" wx:if="{{searchKeyword}}" bindtap="onResetSearch">✕</text>
    </view>
  </view>

  <!-- 内容区域 - 统一白色背景 -->
  <view class="content-section">
    <!-- 分类区域 - 极简标签式导航设计 -->
    <view class="category-section">
      <view class="category-tabs">
        <view 
          wx:for="{{categories}}" 
          wx:key="id"
          class="category-tab {{item.active ? 'active' : ''}}"
          data-category="{{item.value}}"
          bindtap="onCategoryClick"
        >
          {{item.name}}
        </view>
      </view>
    </view>

    <!-- 封面网格 -->
    <view class="covers-section">
      <view class="covers-grid">
        <view 
          class="cover-item" 
          wx:for="{{coverList}}" 
          wx:key="material_id"
        >
          <view class="cover-image-container">
            <image class="cover-image" src="{{item.image}}" mode="aspectFill" bindtap="previewCover" data-cover="{{item}}" lazy-load="true"></image>
          </view>
          <!-- 已去除右上角导出按钮 -->
          <!-- 右下角收藏按钮 - 已隐藏 -->
          <view class="favorite-btn" catchtap="toggleFavorite" data-item="{{item}}" style="display: none;">
            <text class="favorite-icon">{{item.isFavorite ? '❤️' : '🤍'}}</text>
          </view>
          <!-- 已去除书籍名称显示 -->
        </view>
      </view>

      <!-- 空状态 -->
      <view class="empty-state" wx:if="{{coverList.length === 0}}">
        <text class="empty-icon">📖</text>
        <text class="empty-text">暂无相关封面</text>
        <text class="empty-desc">尝试调整搜索条件</text>
      </view>

      <!-- 自动加载提示 -->
      <view class="auto-loading" wx:if="{{isLoading && hasMore}}">
        <view class="loading-container">
          <view class="loading-spinner"></view>
          <text class="loading-text">正在加载更多封面...</text>
        </view>
      </view>
      
      <!-- 加载完成提示 -->
      <view class="load-complete" wx:if="{{!hasMore && coverList.length > 0}}">
        <view class="complete-container">
          <text class="complete-icon">✓</text>
          <text class="complete-text">已加载全部封面</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 壁纸预览组件 -->
  <wallpaper-preview 
    show-preview="{{showWallpaperPreview}}"
    current-wallpaper="{{currentPreviewWallpaper}}"
    current-tag="{{currentPreviewTag}}"
    bind:close="onCloseWallpaperPreview"
    bind:download="onDownloadWallpaper"
  />

  <!-- 现代化壁纸预览模态框 -->
  <view class="wallpaper-preview-modal" wx:if="{{showPreview}}" catchtouchmove="preventTouchMove">
    <!-- 半透明黑色遮罩层 -->
    <view class="preview-mask" catchtouchmove="preventTouchMove"></view>
    
    <!-- 预览内容区域 -->
    <view class="preview-content" catchtouchmove="preventTouchMove">

      <!-- 预览界面返回容器 -->
      <view class="preview-return-navbar">
        <!-- 左边返回按钮 -->
        <view class="nav-button left-button" catchtap="onClosePreview">
          <image class="nav-icon" src="/images/back-icon.png"></image>
        </view>
        
        <!-- 中间分隔竖线 -->
        <view class="nav-separator"></view>
        
        <!-- 右边首页按钮 -->
        <view class="nav-button right-button" catchtap="onGoHome">
          <image class="nav-icon" src="/images/home-icon.png"></image>
        </view>
      </view>
      
      <!-- 壁纸展示区域 - 使用swiper实现左右滑动切换 -->
      <view class="wallpaper-container">
        <swiper 
          class="preview-swiper"
          indicator-dots="false"
          circular="true"
          duration="300"
          current="{{currentPreviewIndex}}"
          bindchange="onSwiperChange"
        >
          <block wx:for="{{previewCoverList}}" wx:key="material_id">
            <swiper-item class="preview-swiper-item">
              <view class="wallpaper-wrapper">
                <image 
                  class="wallpaper-image" 
                  src="{{item.image}}" 
                  mode="widthFix"
                ></image>
                
                <!-- iOS锁屏样式时间日期 - 作为壁纸容器的子级 -->
                <view class="lock-screen-info">
                  <text class="lock-time">{{currentTime}}</text>
                  <text class="lock-date">{{currentDate}}</text>
                </view>
              </view>
            </swiper-item>
          </block>
        </swiper>
        
        <!-- 当前图片指示器 -->
        <view class="preview-indicator" wx:if="{{previewCoverList.length > 1}}">
          <text class="indicator-text">{{currentPreviewIndex + 1}} / {{previewCoverList.length}}</text>
        </view>
        
        <!-- 预览界面加载状态提示 -->
        <view class="preview-loading" wx:if="{{previewIsLoading}}">
          <view class="loading-container">
            <view class="loading-spinner"></view>
            <text class="loading-text">正在加载更多封面...</text>
          </view>
        </view>
        
        <!-- 预览界面加载完成提示 -->
        <view class="preview-load-complete" wx:if="{{!previewHasMore && previewCoverList.length > 0}}">
          <view class="complete-container">
            <text class="complete-icon">✓</text>
            <text class="complete-text">已加载全部封面</text>
          </view>
        </view>
      </view>
      
      <!-- 底部下载按钮 - 与壁纸容器同级 -->
      <view class="preview-footer">
        <button class="download-btn" bindtap="downloadPreview">
          <text class="download-icon">⬇️</text>
          <text class="download-text">立即下载</text>
        </button>
      </view>
    </view>
  </view>

  <!-- 广告提示模态框 -->
  <view class="ad-modal" wx:if="{{showAdModal}}">
    <view class="modal-mask" bindtap="closeAdModal"></view>
    <view class="ad-modal-content">
      <view class="ad-modal-header">
        <text class="ad-modal-title">解锁下载权限</text>
        <text class="ad-modal-close" bindtap="closeAdModal">✕</text>
      </view>
      <view class="ad-modal-body">
        <view class="ad-modal-icon">📱</view>
        <text class="ad-modal-desc">获取下载次数</text>
        <text class="ad-modal-subtitle">观看广告，可获得<text class="highlight-count">2次</text>下载次数！</text>
      </view>
      <view class="ad-modal-actions">
        <button class="ad-modal-btn cancel-btn" bindtap="closeAdModal">再想想</button>
        <button class="ad-modal-btn confirm-btn" bindtap="showAd">立即解锁</button>
      </view>
    </view>
  </view>

</view>